# Con-In-A-Box RESTful Web API

The CIAB RESTful Web API is designed to allow access to the Con In A Box functionality from a variety of web clients as well as more cleanly divide the front end and back ends of the main CIAB web site.

## About the API
The goal of this document is to explain the use of the web API, tracking all the requests and responses that have been implemented to allow a web application to access and use the convention data.

## Getting Started

### Prerequisites
To get started using the API, you will need the following:

* A server, with the API installed.
* A development workstation that can connect with the server. To follow along with the samples, a command line with a working 'curl' command would help.
* A basic understanding of what a RESTful API is, and how it works.

### API Configuration
For the most part there is not additional special configuration required for the RESTful API. All the configuration currently does for the core web site is integrated into API as well. Custom configuration for the API will be done in the `api/src/App/Settings.php` file as it is needed.

For the OAuth2 configuration an entry into the database needs to be made for the client of the API. For a very basic setup add an entry to the `oauth_clients` table with a `client_id`. All other fields can be left `NULL`.

### Logging In
In order to use the RESTful API you need to be able log in. The API uses OAuth 2 as its authentication method and requires an `Authorization` header that is generated by the authentication.

Using the password grant you can get a token using the following call

```
curl http://$server/api/token -d \
'grant_type=password&username=$user_email\
 &password=$user_password&client_id=$clientid'
```

* `$server` is the API server
* `$user_name` is the user authenticating
* `$user_password` is the user password
* `clientid` is the client_id in the `oauth_clients` table.

When successful you will get a response something like this:

```
{"access_token":"dab4b2ef8a755c55a9b548044b949218fa9540ec","expires_in":3600,"token_type":"Bearer","scope":null,"refresh_token":"e2af7ed08d374901a389051f93cec5d720fcebac"}
```

That `access_token` becomes the `Bearer` token for authenticating your web API calls such as the following:

```
curl -v -X GET \
  -H 'Authorization: Bearer dab4b2ef8a755c55a9b548044b949218fa9540ec'
  http://$server/api/member/
```

### Refreshing a Token
By default, `access_tokens` are only good for an hour. However they can be renewed without having to fully re-authenticate. This is done using the `refresh_token`

```
curl http://$server/api/token -d \
'grant_type=refresh_token&refresh_token=$token&\
 client_id=$clientid'
```

The `$token` is the refresh token returned on initial authentication which can be stored by the client. The `$clientid` needs to match the `client_id` used to log-in. After refreshed the old `access_token` and `refresh_token` become invalid and a new set of tokens are returned to be used.

```
{"access_token":"c12744fb610aa23cf55f5e5935f904ba541fdd48","expires_in":3600,"token_type":"Bearer","scope":null,"refresh_token":"6de1ba094e9ce131ced56338eb5e30468970ca07"}
```
A refresh token is good, by default, for 14 days.

## Common Parameters
The following parameters are available on all requests using the API

| Parameter  | Meaning | Notes |
|---|---|---|
| **pretty** | Returns response with indentations and line breaks | * Returns the response in a human-readable format if `true`. <br> * Default value: `false` |
|**fields**| Selector specifying a subset of fields to include in the response.| * Use for better performance <br> * The field `type` will always be included|
|**include**| Include the contents of a given resource identifier instead of the identifier.| * Larger responses but requires fewer followup queries <br> * What fields are includable will be specified in each object resource.|


## API Errors
All API calls can potentially return an error response.

| Object Property | Value | Description |
|---|---|---|
| type | string | **error** |
| code | integer | Code of the generated error |
| status | string | Short status of the error |
| message | string | Longer human readable error message |

Where applicable, the code of an error will match known HTTP error codes.

| Error Code | Meaning | Notes |
|---|---|---|
| 400 | Bad Request | The API request is poorly generated and unable to be attempted.|
| 401 | Not Authorized | General error code generated when the authentication has expired or is not valid.|
| 403 | Forbidden | This code will generally appear when the API attempts to perform an action it is not allowed to on an object whose existence they are permitted to know.|
| 404 | Not Found | This code will appear if the API attempts to access an object that does not exist.|
| 405 | Method Not Allowed | The API call that was attempted has been disabled and cannot be used. |
| 406 | Not Acceptable | The Accept headers are requesting a format that is unable to be generated by the API.|
| 409 | Conflict | At attempt was made to edit a resource which has changed beneath the API in a way where merging could not be handled gracefully.|
| 500 | Internal Failure | Something in the internal processing of the API request failed in an unexpected way.|

## HateOAS
Every API call will return an array of HATEOAS ("Hypermedia as the Engine of Application State") links. These links remove any need for you to build or hard code any logic to create URLs into your application. The API will provide the HATEOAS links for each resource and transition the resource can accommodate.

A HATEOAS link object is as follows:

```
{
	"method":{string},
	"href":{string},
	"request":{string}
}
```
HATEOS objects have the following properties:

|Object Property|Value|Description
|---|---|---|
|method|string|The method name|
|href|string|The full URL for this method|
|request|string|The HTTP request used {GET, PUT, POST, DELETE}

HATEOAS links will include a link for each request in the object that can operate on a resource. If there are HATEOAS links beyond those that would describe the set of requests available on that resource, there will be a table like the one shown below describing the additional HATEOAS links the object will return:

HATEOAS Method|Request|Description
|---|---|---|
|self|GET|Get information about the object|

## Modules
A number of modules exist in the API. These modules, while enabled by default, can be explicitly disabled. When enabled a module may not only have additional resources to be used but can add additional properties and/or methods to the base resources.

 * [Concom](Concom.md)
 * [Registration](Registration.md)

<a name="resources"></a>
## Resources
* [Admin](Admin.md)
* [Announcement](Announcement.md)
* [Annual Cycle](Cycle.md)
* [Deadline](Deadline.md)
* [Department](Department.md)
* [Event](Event.md)
* [Member](Member.md)
* [Permissions](Permissions.md)

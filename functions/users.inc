<?php

/*.
    require_module 'standard';
    require_module 'json';
.*/

/*********************************/
/* Neon migration path functions */
/*********************************/


function _quote($value)
{
    if ($value === null || $value === '') {
        return 'NULL';
    } else {
        return MyPDO::quote($value);
    }

}


function _memberDBfromList($person)
{
    $aid = $person['Account ID'];
    $fn = _quote($person['First Name']);
    $ln = _quote($person['Last Name']);
    $mn = _quote($person['Middle Name']);
    $su = _quote($person['Suffix']);
    $em1 = _quote($person['Email 1']);
    $em2 = _quote($person['Email 2']);
    $em3 = _quote($person['Email 3']);
    $ph1 = _quote($person['Phone 1 Full Number (F)']);
    $ph2 = _quote($person['Phone 2 Full Number (F)']);
    $al1 = _quote($person['Address Line 1']);
    $al2 = _quote($person['Address Line 2']);
    $ac = _quote($person['City']);
    $ast = _quote($person['State']);
    $az = _quote($person['Zip Code']);
    $azs = _quote($person['Zip Code Suffix']);
    $aco = _quote($person['Country']);
    $ap = _quote($person['Province']);
    $dc = ($person['Deceased'] === 'Yes') ? 'true' : 'false';
    $dnc = ($person['Do Not Contact'] === 'Yes') ? 'true' : 'false';
    $eoo = ($person['Email Opt-Out'] === 'Yes') ? 'true' : 'false';
    if ($person['DOB Month']) {
        $time = strtotime($person['DOB Month'].'/'.$person['DOB Day'].'/'.$person['DOB Year']);
        $dob = _quote(date('Y-m-d', $time));
    } else {
        $dob = 'NULL';
    }
    $gn = _quote($person['Gender']);
    $pfn = _quote($person['Preferred First Name']);
    $pln = _quote($person['Preferred Last Name']);
    $li = _quote($person['Account Login Name']);
    if ($person['CVGConCom Publish Phone'] === null) {
        $dph = 'NULL';
    } else {
        $dph = $person['CVGConCom Publish Phone'];
    }

    $sql = <<<SQL
        REPLACE INTO `Members` (AccountID, FirstName, MiddleName, LastName,
            Suffix, Email, Email2, Email3, Phone, Phone2,
            AddressLine1, AddressLine2, AddressCity,
            AddressState, AddressZipCode, AddressZipCodeSuffix,
            AddressCountry, AddressProvince, PreferredFirstName,
            PreferredLastName, Login, Deceased, DoNotContact, EmailOptOut,
            Birthdate, Gender, DisplayPhone)
        VALUES ($aid, $fn, $mn,$ln,
                $su, $em1, $em2, $em3, $ph1, $ph2,
                $al1, $al2, $ac,
                $ast, $az, $azs,
                $aco, $ap, $pfn,
                $pln, $li, $dc, $dnc, $eoo,
                $dob, $gn, $dph);

SQL;
    return $sql;

}


function neon_importAccountListToDB($results)
{
    if (!array_key_exists('_MAX_SQL_LENGTH', $GLOBALS)) {
        $sql = "SHOW VARIABLES LIKE 'max_allowed_packet';";
        $result = \DB::run($sql);
        $value = $result->fetch();
        $GLOBALS['_MAX_SQL_LENGTH'] = intval($value['Value']) / 160;
    }

    $sql = "";
    if (isset($results['operationResult']) && $results['operationResult'] == 'SUCCESS') {
        foreach ($results['searchResults'] as $val) {
            $line = _memberDBfromList($val);
            if (strlen($sql) + strlen($line) >= $GLOBALS['_MAX_SQL_LENGTH']) {
                \DB::run($sql);
                $sql = $line;
            } else {
                $sql .= $line;
            }
        }
    }

    if (!empty($sql)) {
        \DB::run($sql);
    }

}


/*************************************/
/* END Neon migration path functions */
/*************************************/


function _parse_user($result, $additional_fields)
{
    $user = array();

    $user['Id'] = $result['Account ID'];
    if (!empty($result['Preferred First Name'])) {
        $user['First Name'] = $result['Preferred First Name'];
    } else {
        $user['First Name'] = $result['First Name'];
    }
    if (!empty($result['Preferred Last Name'])) {
        $user['Last Name'] = $result['Preferred Last Name'];
    } else {
        $user['Last Name'] = $result['Last Name'];
    }
    if (class_exists('\\concom\\POSITION') && method_exists('\\concom\\POSITION', 'getConComPosition')) {
        $value = concom\POSITION::getConComPosition($user['Id']);
        if (!empty($value)) {
            $user['ConCom'] = $value;
        }
    }
    if (!empty($result['Email 1'])) {
        $user['Email'] = $result['Email 1'];
    }
    if (!empty($additional_fields)) {
        foreach ($additional_fields as $field) {
            $user[$field] = $result[$field];
        }
    }

    return $user;

}


function _lookup_user($criteria, $single_result = false, $additional_fields = array(), $page = 1, & $output = null)
{
    global $Neon;
    $preferredFirstName = search_definedFields('Preferred First Name');
    $preferredLastName = search_definedFields('Preferred Last Name');
    $cvgConComPhoneDisplay = search_definedFields('CVGConCom Publish Phone');

    $search = [
    'method' => 'account/listAccounts',
    'columns' => [
    'standardFields' => ['Account ID', 'First Name', 'Last Name', 'Middle Name', 'Suffix', 'City', 'State', 'Email 1', 'Email 2', 'Email 3', 'Phone 1 Full Number (F)', 'Phone 2 Full Number (F)', 'Address Type', 'Address Line 1', 'Address Line 2', 'Zip Code', 'Zip Code Suffix', 'Country', 'Province', 'Account Login Name', 'Deceased', 'Do Not Contact', 'Email Opt-Out', 'DOB Day', 'DOB Month', 'DOB Year', 'Gender'],
    'customFields' => [$preferredFirstName, $preferredLastName, $cvgConComPhoneDisplay],
    ],
    'criteria' => $criteria,
    'page' => [
    'currentPage' => $page,
    'pageSize' => 200,
    'sortColumn' => 'Account ID',
    'sortDirection' => 'ASC',
    ],
    ];
    if (!empty($additional_fields)) {
        foreach ($additional_fields as $field) {
            if (!in_array($field, $search['columns']['standardFields'])) {
                $search['columns']['standardFields'][] = $field;
            }
        }
    }
    $results = $Neon->search($search);

    neon_importAccountListToDB($results);

    if (isset($results['operationResult']) && $results['operationResult'] == 'SUCCESS') {
        if ($single_result && $results['page']['totalResults'] > 1) {
            return array('code' => '409 Conflict', 'users' => array());
        } else {
            if ($output === null) {
                $output = ['code' => null, 'users' => array()];
            }
            foreach ($results['searchResults'] as $val) {
                $user = _parse_user($val, $additional_fields);
                array_push($output['users'], $user);
            }
            if ($results['page']['totalPage'] > $page) {
                return _lookup_user($criteria, $single_result, $additional_fields, $page + 1, $output);
            } else {
                return $output;
            }
        }
    }
    return array('code' => '404 Not Found', 'users' => array());

}


function lookup_users_by_ids($id)
{
    $id = trim($id);
    return _lookup_user([['Account ID', 'IN_RANGE', $id]]);

}


function lookup_user_by_id($id)
{
    $id = trim($id);
    return _lookup_user([['Account ID', 'EQUAL', $id]], true);

}


function lookup_users_by_email($email, $single = true, $substring = false)
{
    $email = trim($email);
    if ($substring) {
        $operator = 'CONTAIN';
    } else {
        $operator = 'EQUAL';
    }
    return _lookup_user([['Email', $operator, $email]], $single);

}


$_set = array();


function filter_users($user)
{
    global $_set;
    if (in_array($user['Id'], $_set)) {
        return false;
    } else {
        $_set[] = $user['Id'];
        return true;
    }

}


function sort_users($a, $b)
{
    return intval($a['Id']) > intval($b['Id']);

}


function merge_results($result1, $result2)
{
    global $_set;
    $_set = array();
    $output = ['code' => '404 Not Found', 'users' => array()];

    if ($result1['code'] === null) {
        $output['code'] = null;
        $output['users'] = array_merge($output['users'], $result1['users']);
        foreach ($result1['users'] as $u) {
            $_set[] = $u['Id'];
        }
    }

    if ($result2['code'] === null) {
        if ($output['code'] === null) {
            $result = array_filter($result2['users'], 'filter_users');
        } else {
            $result = $result2['users'];
            $output['code'] = null;
        }
        $output['users'] = array_merge($output['users'], $result);
    }

    usort($output['users'], "sort_users");

    return $output;

}


function lookup_users_by_name($name, $single = false, $substring = false)
{
    $name = trim(preg_replace('/\s+/', ' ', $name));
    if ($substring) {
        $names = explode(" ", $name);
        if (count($names) < 2) {
            $result = _lookup_user([['First Name', 'CONTAIN', $name]], $single);
            $result2 = _lookup_user([['Last Name', 'CONTAIN', $name]], $single);
            return merge_results($result, $result2);
        } else {
            return _lookup_user(
                [['First Name', 'EQUAL', $names[0]],
                                 ['Last Name', 'CONTAIN', $names[1]]],
                $single
            );
        }
    } else {
        $names = explode(" ", $name);
        if (count($names) != 2) {
            return ['code' => '400 Bad Request', 'users' => array()];
        }
        return _lookup_user(
            [['First Name', 'EQUAL', $names[0]],
                             ['Last Name', 'EQUAL', $names[1]]],
            $single
        );
    }

}


function lookup_users_by_pref_name($name, $single = false, $substring = false)
{
    $name = trim(preg_replace('/\s+/', ' ', $name));
    $preferredFirstName = search_definedFields('Preferred First Name');
    $preferredLastName = search_definedFields('Preferred Last Name');
    if ($substring) {
        $names = explode(" ", $name);
        if (count($names) < 2) {
            $result = _lookup_user([[$preferredFirstName, 'CONTAIN', $name]], $single);
            $result2 = _lookup_user([[$preferredLastName, 'CONTAIN', $name]], $single);
            return merge_results($result, $result2);
        } else {
            $result = _lookup_user(
                [[$preferredFirstName, 'EQUAL', $names[0]],
                 [$preferredLastName, 'CONTAIN', $names[1]]
                ],
                $single
            );
            $result2 = _lookup_user(
                [['First Name', 'EQUAL', $names[0]],
                 [$preferredLastName, 'CONTAIN', $names[1]]
                ],
                $single
            );
            $result = merge_results($result, $result2);
            $result2 = _lookup_user(
                [['First Name', 'EQUAL', $names[0]],
                 ['Last Name', 'CONTAIN', $names[1]]
                ],
                $single
            );
            $result = merge_results($result, $result2);
            $result2 = _lookup_user(
                [[$preferredFirstName, 'EQUAL', $names[0]],
                 ['Last Name', 'CONTAIN', $names[1]]
                ],
                $single
            );
            $result = merge_results($result, $result2);
            return $result;
        }
    } else {
        $names = explode(" ", $name);
        if (count($names) != 2) {
            return ['code' => '400 Bad Request', 'users' => array()];
        }

        /* We have to do a few searchs due to Neon stupidity */
        $output = _lookup_user(
            [[$preferredFirstName, 'EQUAL', $names[0]],
             [$preferredLastName, 'EQUAL', $names[1]]],
            $single
        );
        if (count($output['users']) != 0) {
            return $output;
        }
        $output = _lookup_user(
            [[$preferredFirstName, 'EQUAL', $names[0]],
             ['Last Name', 'EQUAL', $names[1]]],
            $single
        );
        if (count($output['users']) != 0) {
            return $output;
        }
        return _lookup_user(
            [['First Name', 'EQUAL', $names[0]],
             [$preferredLastName, 'EQUAL', $names[1]]],
            $single
        );
    }

}


function lookup_users_by_badgename(
    $badge,
    $single_user = false,
    $substring = false
) {
    $badge = trim($badge);
    if ($substring) {
        $sql = <<<SQL
            SELECT
                AccountID
            FROM
                `Registrations`
            WHERE
                BadgeName LIKE '%{$badge}%';
SQL;
    } else {
        $sql = <<<SQL
            SELECT
                AccountID
            FROM
                `Registrations`
            WHERE
                BadgeName = '$badge';
SQL;
    }
    $result = DB::run($sql);
    $value = $result->fetch();
    $users = [];
    while ($value !== false) {
        if ($single_user && count($users) > 1) {
            return array('code' => '409 Conflict', 'users' => array());
        }
        $users[] = lookup_user_by_id($value['AccountID'])['users'][0];
        $value = $result->fetch();
    }

    return array('code' => null, 'users' => $users);

}


function lookup_users_by_key($key, $single = true, $badgename = true, $substring = false)
{
    $key = trim(preg_replace('/\s+/', ' ', $key));
    if ($substring) {
        $output = ['code' => '404 Not Found', 'users' => array()];
        if (is_numeric($key) ||
            (strtoupper($key)[0] == 'A' && is_numeric(substr($key, 1)))) {
            if (strtoupper($key)[0] == 'A') {
                $result = lookup_user_by_id(substr($key, 1));
                $output = merge_results($output, $result);
            } else {
                $result = lookup_user_by_id($key);
                $output = merge_results($output, $result);
            }
        }
        $result = lookup_users_by_email($key, $single, true);
        $output = merge_results($output, $result);
        $result = lookup_users_by_name($key, $single, true);
        $output = merge_results($output, $result);
        $result = lookup_users_by_pref_name($key, $single, true);
        $output = merge_results($output, $result);
        $result = lookup_users_by_badgename($key, $single, true);
        $output = merge_results($output, $result);
        return $output;
    } else {
        if (is_numeric($key) ||
            (strtoupper($key)[0] == 'A' && is_numeric(substr($key, 1)))) {
            if (strtoupper($key)[0] == 'A') {
                return lookup_user_by_id(substr($key, 1));
            } else {
                return lookup_user_by_id($key);
            }
        } elseif (strpos($key, '@') !== false) {
            return lookup_users_by_email($key, $single);
        } else {
            $output = lookup_users_by_name($key, $single);
            if (count($output['users']) == 0) {
                $output = lookup_users_by_pref_name($key, $single);
            }
            if ($badgename && count($output['users']) == 0) {
                $output = lookup_users_by_badgename($key, $single);
            }
            return $output;
        }
    }

}


function lookup_users_by_name_email($first, $last, $email, $fields, $single_user = false, $substring = false)
{
    $criteria = array();
    if ($first) {
        if ($substring) {
            array_push($criteria, ['First Name', 'CONTAIN', $first]);
        } else {
            array_push($criteria, ['First Name', 'EQUAL', $first]);
        }
    }
    if ($last) {
        if ($substring) {
            array_push($criteria, ['Last Name', 'CONTAIN', $last]);
        } else {
            array_push($criteria, ['Last Name', 'EQUAL', $last]);
        }
    }
    if ($email) {
        if ($substring) {
            array_push($criteria, ['Email', 'CONTAIN', $email]);
        } else {
            array_push($criteria, ['Email', 'EQUAL', $email]);
        }
    }

    return _lookup_user($criteria, $single_user, $fields);

}


function lookup_user_by_login($user, $substring = false)
{
    $output = lookup_users_by_email($user, false);
    if (count($output['users']) == 0) {
        if ($substring) {
            $output = _lookup_user([['Account Login Name', 'CONTAIN', $user]], false);
        } else {
            $output = _lookup_user([['Account Login Name', 'EQUAL', $user]], false);
        }
    }
    if (count($output['users']) == 0) {
        return array();
    } else {
        foreach ($output['users'] as $key => $user) {
            $output['users'][$key]['AccountID'] = $user['Id'];
        }
        return $output['users'];
    }

}


function pullIndividualAccount($accountId)
{
    global $Neon;
    // Refresh Account info from Neon to verify update
    $request = [
    'method' => 'account/retrieveIndividualAccount',
    'parameters' => [
    'accountId' => $accountId,
      ],
    ];

    $result = $Neon->go($request);
    if (isset($result['operationResult']) && $result['operationResult'] == 'SUCCESS') {
        return $result;
    } else {
        sendError("Could not retrieve IndividualAccount for account ".$accountId." in ".__FILE__, $result);
        return null;
    }

}


function listStates()
{
    return array(
        ['code' => 'AL', 'name' => 'ALABAMA'],
        ['code' => 'AK', 'name' => 'ALASKA'],
        ['code' => 'AS', 'name' => 'AMERICAN SAMOA'],
        ['code' => 'AZ', 'name' => 'ARIZONA'],
        ['code' => 'AR', 'name' => 'ARKANSAS'],
        ['code' => 'CA', 'name' => 'CALIFORNIA'],
        ['code' => 'CO', 'name' => 'COLORADO'],
        ['code' => 'CT', 'name' => 'CONNECTICUT'],
        ['code' => 'DE', 'name' => 'DELAWARE'],
        ['code' => 'DC', 'name' => 'DISTRICT OF COLUMBIA'],
        ['code' => 'FM', 'name' => 'FEDERATED STATES OF MICRONESIA'],
        ['code' => 'FL', 'name' => 'FLORIDA'],
        ['code' => 'GA', 'name' => 'GEORGIA'],
        ['code' => 'GU', 'name' => 'GUAM GU'],
        ['code' => 'HI', 'name' => 'HAWAII'],
        ['code' => 'ID', 'name' => 'IDAHO'],
        ['code' => 'IL', 'name' => 'ILLINOIS'],
        ['code' => 'IN', 'name' => 'INDIANA'],
        ['code' => 'IA', 'name' => 'IOWA'],
        ['code' => 'KS', 'name' => 'KANSAS'],
        ['code' => 'KY', 'name' => 'KENTUCKY'],
        ['code' => 'LA', 'name' => 'LOUISIANA'],
        ['code' => 'ME', 'name' => 'MAINE'],
        ['code' => 'MH', 'name' => 'MARSHALL ISLANDS'],
        ['code' => 'MD', 'name' => 'MARYLAND'],
        ['code' => 'MA', 'name' => 'MASSACHUSETTS'],
        ['code' => 'MI', 'name' => 'MICHIGAN'],
        ['code' => 'MN', 'name' => 'MINNESOTA'],
        ['code' => 'MS', 'name' => 'MISSISSIPPI'],
        ['code' => 'MO', 'name' => 'MISSOURI'],
        ['code' => 'MT', 'name' => 'MONTANA'],
        ['code' => 'NE', 'name' => 'NEBRASKA'],
        ['code' => 'NV', 'name' => 'NEVADA'],
        ['code' => 'NH', 'name' => 'NEW HAMPSHIRE'],
        ['code' => 'NJ', 'name' => 'NEW JERSEY'],
        ['code' => 'NM', 'name' => 'NEW MEXICO'],
        ['code' => 'NY', 'name' => 'NEW YORK'],
        ['code' => 'NC', 'name' => 'NORTH CAROLINA'],
        ['code' => 'ND', 'name' => 'NORTH DAKOTA'],
        ['code' => 'MP', 'name' => 'NORTHERN MARIANA ISLANDS'],
        ['code' => 'OH', 'name' => 'OHIO'],
        ['code' => 'OK', 'name' => 'OKLAHOMA'],
        ['code' => 'OR', 'name' => 'OREGON'],
        ['code' => 'PW', 'name' => 'PALAU'],
        ['code' => 'PA', 'name' => 'PENNSYLVANIA'],
        ['code' => 'PR', 'name' => 'PUERTO RICO'],
        ['code' => 'RI', 'name' => 'RHODE ISLAND'],
        ['code' => 'SC', 'name' => 'SOUTH CAROLINA'],
        ['code' => 'SD', 'name' => 'SOUTH DAKOTA'],
        ['code' => 'TN', 'name' => 'TENNESSEE'],
        ['code' => 'TX', 'name' => 'TEXAS'],
        ['code' => 'UT', 'name' => 'UTAH'],
        ['code' => 'VT', 'name' => 'VERMONT'],
        ['code' => 'VI', 'name' => 'VIRGIN ISLANDS'],
        ['code' => 'VA', 'name' => 'VIRGINIA'],
        ['code' => 'WA', 'name' => 'WASHINGTON'],
        ['code' => 'WV', 'name' => 'WEST VIRGINIA'],
        ['code' => 'WI', 'name' => 'WISCONSIN'],
        ['code' => 'WY', 'name' => 'WYOMING'],
        ['code' => 'AE', 'name' => 'ARMED FORCES AFRICA \ CANADA \ EUROPE \ MIDDLE EAST'],
        ['code' => 'AA', 'name' => 'ARMED FORCES AMERICA (EXCEPT CANADA)'],
        ['code' => 'AP', 'name' => 'ARMED FORCES PACIFIC']
    );

}


function listCountries()
{
    $datafile = file_get_contents(__DIR__.'/../data/countries.json');
    $data = json_decode($datafile);

    $countries = array();
    foreach ($data as $key => $line) {
        array_push($countries, ['id' => $key, 'name' => $line]);
    }

    return $countries;

}


function updateAccount($updateData)
{
    global $Neon, $_SESSION;

    // Formulate the update
    $request = [
    'method' => 'account/updateIndividualAccount',
    'parameters' => [
    'individualAccount.accountId' => $updateData['accountId'],
    'individualAccount.primaryContact.contactId' => $updateData['contactId'],
    'individualAccount.primaryContact.firstName' => $updateData['firstName'],
    'individualAccount.primaryContact.middleName' => $updateData['middleName'],
    'individualAccount.primaryContact.lastName' => $updateData['lastName'],
    'individualAccount.primaryContact.suffix' => $updateData['suffix'],
    'individualAccount.primaryContact.email1' => $updateData['email1'],
    'individualAccount.primaryContact.email2' => $updateData['email2'],
    'individualAccount.primaryContact.email3' => $updateData['email3'],
    'individualAccount.primaryContact.phone1' => $updateData['phone1'],
    'individualAccount.primaryContact.phone2' => $updateData['phone2'],
    'individualAccount.primaryContact.addresses.address.addressType.Name' => 'Home',
    'individualAccount.primaryContact.addresses.address.addressId' => $updateData['addressId'],
    'individualAccount.primaryContact.addresses.address.isPrimaryAddress' => 'true',
    'individualAccount.primaryContact.addresses.address.addressLine1' => $updateData['addressLine1'],
    'individualAccount.primaryContact.addresses.address.addressLine2' => $updateData['addressLine2'],
    'individualAccount.primaryContact.addresses.address.addressLine3' => '',
    'individualAccount.primaryContact.addresses.address.addressLine4' => '',
    'individualAccount.primaryContact.addresses.address.city' => $updateData['city'],
    'individualAccount.primaryContact.addresses.address.state.code' => $updateData['state'],
    'individualAccount.primaryContact.addresses.address.zipCode' => $updateData['zipCode'],
    'individualAccount.primaryContact.addresses.address.zipCodeSuffix' => $updateData['zipPlus4'],
    'individualAccount.primaryContact.addresses.address.country.id' => $updateData['country'],
    'individualAccount.primaryContact.addresses.address.province' => $updateData['province'],
    ],
    ];

    $preferredFirstName = search_definedFields('Preferred First Name');
    $preferredLastName = search_definedFields('Preferred Last Name');
    $cvgConComPhoneDisplay = search_definedFields('CVGConCom Publish Phone');

    $i = count($_SESSION['accountInfo']['individualAccount']['customFieldDataList']['customFieldData']);
    // Verify fieldId is in place - potential for manual add to lottery or override
    $key = array_search($preferredFirstName, array_column($_SESSION['accountInfo']['individualAccount']['customFieldDataList']['customFieldData'], 'fieldId'));
    if ($key === false && !empty($updateData['preferredFirstName'])) {
        $_SESSION['accountInfo']['individualAccount']['customFieldDataList']['customFieldData'][$i]['fieldId'] = $preferredFirstName;
        $_SESSION['accountInfo']['individualAccount']['customFieldDataList']['customFieldData'][$i]['fieldValue'] = $updateData['preferredFirstName'];
        $i++;
    }
    unset($key);
    $key = array_search($preferredLastName, array_column($_SESSION['accountInfo']['individualAccount']['customFieldDataList']['customFieldData'], 'fieldId'));
    if ($key === false && !empty($updateData['preferredLastName'])) {
        $_SESSION['accountInfo']['individualAccount']['customFieldDataList']['customFieldData'][$i]['fieldId'] = $preferredLastName;
        $_SESSION['accountInfo']['individualAccount']['customFieldDataList']['customFieldData'][$i]['fieldValue'] = $updateData['preferredLastName'];
        $i++;
    }
    $key = array_search($cvgConComPhoneDisplay, array_column($_SESSION['accountInfo']['individualAccount']['customFieldDataList']['customFieldData'], 'fieldId'));
    if ($key === false && !empty($updateData['conComDisplayPhone'])) {
        $_SESSION['accountInfo']['individualAccount']['customFieldDataList']['customFieldData'][$i]['fieldId'] = $cvgConComPhoneDisplay;
        $_SESSION['accountInfo']['individualAccount']['customFieldDataList']['customFieldData'][$i]['fieldValue'] = $updateData['conComDisplayPhone'];
        $i++;
    }
    unset($key);
    unset($i);

    // add custom field data, watch for updated fields, if empty, drop them to clear them from Neon
    foreach ($_SESSION['accountInfo']['individualAccount']['customFieldDataList']['customFieldData'] as $key => $val) {
        if ($val['fieldId'] == $preferredFirstName) {
            if (!empty($updateData['preferredFirstName'])) {
                $request['parameters']['individualAccount.customFieldDataList.customFieldData.fieldId['.$key.']'] = $val['fieldId'];
                $request['parameters']['individualAccount.customFieldDataList.customFieldData.fieldOptionId['.$key.']'] = '';
                $request['parameters']['individualAccount.customFieldDataList.customFieldData.fieldValue['.$key.']'] = $updateData['preferredFirstName'];
            }
        } elseif ($val['fieldId'] == $preferredLastName) {
            if (!empty($updateData['preferredLastName'])) {
                $request['parameters']['individualAccount.customFieldDataList.customFieldData.fieldId['.$key.']'] = $val['fieldId'];
                $request['parameters']['individualAccount.customFieldDataList.customFieldData.fieldOptionId['.$key.']'] = '';
                $request['parameters']['individualAccount.customFieldDataList.customFieldData.fieldValue['.$key.']'] = $updateData['preferredLastName'];
            }
        } elseif ($val['fieldId'] == $cvgConComPhoneDisplay) {
            if (!empty($updateData['conComDisplayPhone'])) {
                $request['parameters']['individualAccount.customFieldDataList.customFieldData.fieldId['.$key.']'] = $val['fieldId'];
                $request['parameters']['individualAccount.customFieldDataList.customFieldData.fieldOptionId['.$key.']'] = '';
                $request['parameters']['individualAccount.customFieldDataList.customFieldData.fieldValue['.$key.']'] = $updateData['conComDisplayPhone'];
            }
        } else {
            $request['parameters']['individualAccount.customFieldDataList.customFieldData.fieldId['.$key.']'] = $val['fieldId'];
            if (isset($val['fieldValue'])) {
                $request['parameters']['individualAccount.customFieldDataList.customFieldData.fieldOptionId['.$key.']'] = '';
                $request['parameters']['individualAccount.customFieldDataList.customFieldData.fieldValue['.$key.']'] = $val['fieldValue'];
            } elseif (isset($val['fieldOptionId'])) {
                $request['parameters']['individualAccount.customFieldDataList.customFieldData.fieldOptionId['.$key.']'] = $val['fieldOptionId'];
                $request['parameters']['individualAccount.customFieldDataList.customFieldData.fieldValue['.$key.']'] = '';
            }
        }
    }

    return $Neon->go1($request);

}
